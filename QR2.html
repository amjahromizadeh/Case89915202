const el = (id)=>document.getElementById(id);
const go=el('go'), inp=el('dateIn'), spin=el('spin'), fill=el('fill'), timer=el('timer');
const ok=el('success'), fail=el('fail'), msg=el('msg');


function normalizeDate(s){
return (s||'').trim();
}


function pingWebhook(payload){
if(!WEBHOOK_URL) return;
try{
fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
}catch(e){/* ignore */}
}


function startSpinner(onDone){
spin.style.display='block';
let left = SPIN_MS; const step=500;
const iv = setInterval(()=>{
left-=step; const p=1-(left/SPIN_MS);
fill.style.width = (p*100).toFixed(1)+'%';
const m = Math.max(0, Math.floor(left/60000));
const s = Math.max(0, Math.floor((left%60000)/1000));
timer.textContent = `Processing… ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
if(left<=0){ clearInterval(iv); onDone(); }
}, step);
}


go.addEventListener('click',()=>{
ok.style.display=fail.style.display='none'; msg.textContent='';
const val = normalizeDate(inp.value);
if(val!==CORRECT){
fail.style.display='block';
fail.innerHTML = '<span class="err">Filed.</span> The analyst notes doubt the date. Try again.';
return;
}
// Correct → ping, then spinner → success
pingWebhook({page:'QR2', code:val, case:'89915202', ts:new Date().toISOString()});
go.disabled = true; inp.disabled = true;
startSpinner(()=>{
ok.style.display='block';
ok.innerHTML = `<span class="ok">Resolved.</span> <a class="btn btnlink" href="${MAPS_URL}" target="_blank" rel="noopener">Open in Maps</a>`;
});
});


el('hintBtn').addEventListener('click',()=>{
const h=el('hint'); h.style.display = (h.style.display==='block')?'none':'block';
});
</script>
</body>
</html>